# ![logo](https://i.imgur.com/zqJELkl.png)
<p align="center">
 <img src="https://img.shields.io/badge/License-MIT-blue.svg">
 <img src="https://badges.frapsoft.com/os/v3/open-source.svg?v=103">
 <img src="http://ForTheBadge.com/images/badges/built-with-love.svg">
 <img src="https://img.shields.io/badge/badges-awesome-green.svg">
 <img src="https://img.shields.io/badge/Stay-Safe-red?logo=data:image/svg%2bxml;base64,PHN2ZyBpZD0iTGF5ZXJfMSIgZW5hYmxlLWJhY2tncm91bmQ9Im5ldyAwIDAgNTEwIDUxMCIgaGVpZ2h0PSI1MTIiIHZpZXdCb3g9IjAgMCA1MTAgNTEwIiB3aWR0aD0iNTEyIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxnPjxnPjxwYXRoIGQ9Im0xNzQuNjEgMzAwYy0yMC41OCAwLTQwLjU2IDYuOTUtNTYuNjkgMTkuNzJsLTExMC4wOSA4NS43OTd2MTA0LjQ4M2g1My41MjlsNzYuNDcxLTY1aDEyNi44MnYtMTQ1eiIgZmlsbD0iI2ZmZGRjZSIvPjwvZz48cGF0aCBkPSJtNTAyLjE3IDI4NC43MmMwIDguOTUtMy42IDE3Ljg5LTEwLjc4IDI0LjQ2bC0xNDguNTYgMTM1LjgyaC03OC4xOHYtODVoNjguMThsMTE0LjM0LTEwMC4yMWMxMi44Mi0xMS4yMyAzMi4wNi0xMC45MiA0NC41LjczIDcgNi41NSAxMC41IDE1LjM4IDEwLjUgMjQuMnoiIGZpbGw9IiNmZmNjYmQiLz48cGF0aCBkPSJtMzMyLjgzIDM0OS42M3YxMC4zN2gtNjguMTh2LTYwaDE4LjU1YzI3LjQxIDAgNDkuNjMgMjIuMjIgNDkuNjMgNDkuNjN6IiBmaWxsPSIjZmZjY2JkIi8+PHBhdGggZD0ibTM5OS44IDc3LjN2OC4wMWMwIDIwLjY1LTguMDQgNDAuMDctMjIuNjQgNTQuNjdsLTExMi41MSAxMTIuNTF2LTIyNi42NmwzLjE4LTMuMTljMTQuNi0xNC42IDM0LjAyLTIyLjY0IDU0LjY3LTIyLjY0IDQyLjYyIDAgNzcuMyAzNC42OCA3Ny4zIDc3LjN6IiBmaWxsPSIjZDAwMDUwIi8+PHBhdGggZD0ibTI2NC42NSAyNS44M3YyMjYuNjZsLTExMi41MS0xMTIuNTFjLTE0LjYtMTQuNi0yMi42NC0zNC4wMi0yMi42NC01NC42N3YtOC4wMWMwLTQyLjYyIDM0LjY4LTc3LjMgNzcuMy03Ny4zIDIwLjY1IDAgNDAuMDYgOC4wNCA1NC42NiAyMi42NHoiIGZpbGw9IiNmZjRhNGEiLz48cGF0aCBkPSJtMjEyLjgzIDM2MC4xMnYzMGg1MS44MnYtMzB6IiBmaWxsPSIjZmZjY2JkIi8+PHBhdGggZD0ibTI2NC42NSAzNjAuMTJ2MzBoMzYuMTRsMzIuMDQtMzB6IiBmaWxsPSIjZmZiZGE5Ii8+PC9nPjwvc3ZnPg==">

</p>
 <p align="center">
     <a href="https://img.shields.io/github/stars/trinib/AdGuard-WireGuard-Unbound-Cloudflare?color=FFD700&style=for-the-badge" alt="GitHub Repo stars">
         <img src="https://img.shields.io/github/stars/trinib/AdGuard-WireGuard-Unbound-Cloudflare?color=FFD700&style=for-the-badge"></a>
     <a href="https://img.shields.io/github/forks/trinib/AdGuard-WireGuard-Unbound-Cloudflare?color=00a671&style=for-the-badge" alt="GitHub forks">
         <img src="https://img.shields.io/github/forks/trinib/AdGuard-WireGuard-Unbound-Cloudflare?color=00a671&style=for-the-badge"></a>
     <a href="https://img.shields.io/github/watchers/trinib/AdGuard-WireGuard-Unbound-Cloudflare?color=9700b2&style=for-the-badge" alt="GitHub watchers">
         <img src="https://img.shields.io/github/watchers/trinib/AdGuard-WireGuard-Unbound-Cloudflare?color=9700b2&style=for-the-badge"></a>
</p>

<h2><p align="center">
<a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/blob/lang/README.zh-CN.md"><b>🇨🇳</b></a>&nbsp;<a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/blob/lang/README.es.md"><b>🇪🇸</b></a>&nbsp;<a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/blob/lang/README.ru.md"><b>🇷🇺</b></a>&nbsp;<a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/blob/lang/README.hi.md"><b>🇮🇳</b></a>&nbsp;<a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/blob/lang/README.fr.md"><b>🇫🇷</b></a>&nbsp;<a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/blob/lang/README.it.md"><b>🇮🇹</b></a>&nbsp;<a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/blob/lang/README.de.md"><b>🇩🇪</b></a>&nbsp;<a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/blob/lang/README.ar.md"><b>🇦🇪</b></a></h2>

<p align="center"><img src="https://raw.githubusercontent.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/main/assets/images/awcu.gif" width= "700">

#
## Features
 
#### _<a href="https://github.com/AdguardTeam/AdGuardHome/blob/master/README.md"><b>AdGuard Home</b></a>_ : Block ads on all your devices( <a href="https://github.com/AdguardTeam/AdGuardHome/blob/master/README.md#how-does-adguard-home-compare-to-pi-hole"><b>_compared to Pi-Hole_</b></a> )
#### _<a href="https://www.wireguard.com/"><b>WireGuard</b></a>_ : VPN server at home accessible from any outside network(IPv4 & IPv6)
#### <a href="https://www.nlnetlabs.nl/projects/unbound/about/"><b><i>Unbound</i></b></a> with [<i>Stubby</i>](https://dnsprivacy.org/dns_privacy_daemon_-_stubby/about_stubby/) : A validating, recursive, caching DNS resolver
#### _<a href="https://www.cloudflare.com/learning/what-is-cloudflare/"><b>Cloudflare</b></a>_ : Better performance & security when browsing websites(DoT & DoH)
 
<p align="right">
<i>All software are free, open-source and&nbsp;self-hosted&nbsp;</i></br><a href="https://git.io/About"><b>About</b></a> | <a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/discussions/17"><b>F.A.Q</b></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

***

### DNS query speed with <a href="https://docs.oracle.com/en-us/iaas/Content/DNS/Tasks/testingdnsusingdig.htm"><b>BIND'S dig Tool </b></a>🧪

<b>Results from google.com in milliseconds:</b>
 - AdGuard default DNS resolvers - `60-70 msec`
 - Public Cloudflare/Quad9/Google DNS Resolvers - `50-70 msec`
 - This set up/configuration -  `5-10 msec`

<details><summary><b>Preview🎥<img src="https://media.giphy.com/media/WT5h7PgVSScLLKtMaS/giphy.gif" width=50px height=40px></b></summary>
<p>

AdGuard default DNS <b><i>vs</i></b> this set up⭐ :

https://user-images.githubusercontent.com/18756975/150230438-b767e86f-4e18-4791-b5fe-0813615a37a3.mp4

Public Cloudflare/Quad9/Google DNS resolvers :

https://user-images.githubusercontent.com/18756975/150319049-3d8acdc9-624f-4b60-8ee2-b80227522252.mp4

</p>
</details>

***

### Last Checked⏰ : 17 April 2022</h2>

<div align="center">

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  Projects &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;           |   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Status &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;         |
   :---:             |     :---: 
 AdGuard Home        |       ✅
 Unbound             |       ✅
 Cloudflare          |       ✅
 Stubby              |       ✅
 WireGuard           |       ✅    
</div>

# Table of contents
 
- [Requirements](#requirements)
- [Install Raspberry Pi OS](#install-raspberry-pi-os) <img src="https://www.vectorlogo.zone/logos/raspberrypi/raspberrypi-icon.svg" width=20px height=20px>
  - [Access Pi OS with SSH](#access-pi-os-with-ssh)
- [Install AdGuard Home](#install-adguard-home) <img src="https://www.vectorlogo.zone/logos/adguard/adguard-icon.svg" width=20px height=20px>
  - [Set up your devices to work with Adguard](#set-up-your-devices-to-work-with-adguard)
  - [Setting up AdGuard blocklist](#setting-up-adguard-blocklist)
    - [Add/Remove multiple URLs](#addremove-multiple-urls)
- [Install Unbound](#install-unbound) <img src="https://www.privacytools.io/img/apps/unbound.svg" width=20px height=20px>
- [Install Cloudflare](#install-cloudflare) <img src="https://www.vectorlogo.zone/logos/cloudflare/cloudflare-icon.svg" width=20px height=20px>
  - [Setup for Cloudflared (DoH)](#setup-for-cloudflared-doh)
  - [Configure Cloudflare (DoT) on Unbound](#configure-cloudflare-dot-on-unbound)
    - [Configure Stubby for Unbound](#configure-stubby-for-unbound)
    - [Configure AdGuard with Cloudflare (DoH&DoT)](#configure-adguard-with-cloudflaredohdot)
- [Install WireGuard](#install-wireguard) <img src="https://www.vectorlogo.zone/logos/wireguard/wireguard-icon.svg" width=20px height=20px>
   or <a href="https://github.com/trinib/Adguard-Wireguard-Unbound-Cloudflare/blob/main/OpenVPN-Setup.md">OpenVPN(slower)</a> <img src="https://i.imgur.com/Agstbe5.png" width=20px height=20px>
- [Connecting VPN to Android/IOS Phone](#connecting-vpn-to-androidios-phone)
- [Connecting VPN to Windows](#connecting-vpn-to-windows)
- [Configure Wireguard with AdGuard/Unbound/Cloudflare](#configure-wireguard-with-adguardunboundcloudflare)
     - [Limit traffic](#limit-traffic)
     - [IPv6](#ipv6)
     - [Disable all IPv6](#disable-all-ipv6)
- [Test Vpn](#test-vpn) <img src="https://i.imgur.com/6Yf8Zra.png" width=20px height=20px>
- [Auto update Pi](#auto-update-pi)
- [Install Log2ram](#install-log2ram)
- [Turn Off Pi LEDs](#turn-off-pi-led-lights)
- [Secure your Raspberry Pi](#secure-your-raspberry-pi)
- [Repository Resources](#repository-resources)

#
# Requirements
 
This tutorial is based on Raspberry Pi, but you can use any Linux <a href="https://github.com/thibmaek/awesome-raspberry-pi#os-images"><b>operating system</b></a><i>(𝟹𝟸/𝟼𝟺bit)</i>, any hardware or a <a href="https://www.google.com/search?q=What+is+a+VPS+used+for%3F&client=firefox-b-d&biw=1280&bih=582&sxsrf=APq-WBu-yng0bW9IWwNKsQhD6h1ZmRGncw%3A1650151372793&ei=zE9bYpL1L_OOwbkPgZ6DGA&ved=0ahUKEwiSi5rz3Jn3AhVzRzABHQHPAAMQ4dUDCA0&uact=5&oq=What+is+a+VPS+used+for%3F&gs_lcp=Cgdnd3Mtd2l6EAMyBAgAEA0yBAgAEA0yBAgAEA0yBAgAEA0yBggAEA0QHjIGCAAQFhAeMgYIABAWEB4yCAgAEAgQDRAeMggIABAIEA0QHjIICAAQCBANEB46BwgAEEcQsANKBAhBGABKBAhGGABQ8AFY8AFg_ANoAXABeACAAXCIAXCSAQMwLjGYAQCgAQKgAQHIAQjAAQE&sclient=gws-wiz"><b>VPS</b></a>.</br>(Raspberry Pi OS is most simple and recommended for Pi or for more experience users, <b>DietPi</b> OS is also recommended)

   - A Raspberry Pi 3 or 4 version
   - A router that supports port forwarding(Most Can)
   - MicroSD USB card reader
   - MicroSD card (8GB or bigger, at least Class 4)
   - Ethernet cable
   - (Optional if using monitor) MicroHDMI-(RPi 4) or HDMI-(RPi 3)

#

# <i>Install Raspberry Pi OS</b></i>

Raspberry Pi OS comes in desktop and lite versions(use lite for <a href="https://www.google.com/search?q=What+is+a+headless+operating+system%3F&client=firefox-b-d&sxsrf=APq-WBvlqMZasn_klYxS5HZmhKQlduKYuQ%3A1650123816301&ei=KORaYtz7EYOdwbkP74G16AE&ved=0ahUKEwjcr5-f9pj3AhWDTjABHe9ADR0Q4dUDCA0&uact=5&oq=What+is+a+headless+operating+system%3F&gs_lcp=Cgdnd3Mtd2l6EAMyCAghEBYQHRAeOgcIABBHELADSgQIQRgASgQIRhgAUMEBWMEBYNAEaAFwAXgAgAFqiAFqkgEDMC4xmAEAoAECoAEByAEIwAEB&sclient=gws-wiz"><b>headless</b></a> mode). You can access a Raspberry Pi with a monitor/keyboard/mouse or connect via <a href="https://www.google.com/search?q=linux+ssh+&client=firefox-b-d&sxsrf=APq-WBve72uwEMMqUAe77nZoaygcx-ROMg%3A1650123667623&ei=k-NaYtbfJbmvwbkPpf6nqAQ&ved=0ahUKEwiW9azY9Zj3AhW5VzABHSX_CUUQ4dUDCA0&uact=5&oq=linux+ssh+&gs_lcp=Cgdnd3Mtd2l6EAMyBAgjECcyBQgAEIAEMgUIABCRAjIFCAAQkQIyBQgAEIAEMgUIABCABDIFCAAQkQIyBQgAEIAEMgUIABCABDIFCAAQgAQ6BwgAEEcQsANKBAhBGABKBAhGGABQuAFY0AJg1AZoAXABeACAAXaIAeIBkgEDMC4ymAEAoAEByAEIwAEB&sclient=gws-wiz"><b>ssh</b></a> from a terminal.

Install balenEtcher and download Pi image to write on the microSD card.

 * Download Raspberry Pi OS: https://www.raspberrypi.org/software/operating-systems/

 * Download balenaEtcher: https://www.balena.io/etcher/

After you have `Etcher` installed and `Raspberry Pi OS` file downloaded, you can now insert the SD card with microSD USB card reader into your computer.

- Launch Etcher and choose the Raspberry Pi OS image that you downloaded, select your microSD card and click `Flash`.

After flashing is done, look in "This PC” for a disk name “boot or USB drive” (re-plug USB card reader if not seen). Go to that disk, create a new text file called **_`ssh without 'txt' extension`_**. Disable “Hide extensions for known file types” in the file explorer options if you don't see it.

<p align="center">
 <img src="https://i.imgur.com/eV6uMbz.jpg">

<i>Place SD card into the Raspberry Pi, plug in Ethernet cable and boot up</i>

## Access Pi OS with SSH

 * Wait for a minute for Pi's first boot up

 * Open browser and log in your router's panel page

 * Find list of all devices connected to your network and copy the IP address of the Raspberry Pi (it will most likely have the hostname `raspberrypi`)

 * Open terminal on your host machine. You can use powerShell on Windows or RaspController for android.

Type the following command:
```
ssh pi@pi's IP address
```
<i>You can use right mouse button to paste text in Windows powerShell</i>.

Type “yes” for fingerprint question, and type "raspberry" for default password(passwords will be invisible in command line). You can type **_`sudo passwd pi`_** to change password after.

<p align="center">
 <img src="https://i.imgur.com/Wf30jxG.jpg">

Run in terminal:
```
sudo apt update -y && sudo apt upgrade -y
```
*_Reboot when finished_*
```
sudo reboot
```
**[⬆ Return to contents ⬆](#table-of-contents)**

#
# <i>Install AdGuard Home</b></i>

This installation script is from <a href="https://github.com/AdguardTeam/AdGuardHome/blob/master/README.md"><b>AdGuard Home</b></a> main project. Follow to keep updated.

Run the following command in your terminal:
```
curl -s -S -L https://raw.githubusercontent.com/AdguardTeam/AdGuardHome/master/scripts/install.sh | sh -s -- -v
```
 * When installation is finished, a window will pop up in terminal showing `links` to your AdGuard home page(Get Started)

 * `IMPORTANT:` In Listen Interfaces option choose `Eth0` and select next
 
 <p align="center">
  <img src="https://i.imgur.com/Wa00lDp.jpg" width=580px height=690px>

 * Set up username & password and login into admin panel

 * `IMPORTANT:` In general settings, set "Query logs retention" to `24 hours`. (I read that for some people logs fill up which slows down Pi and needing a reboot)

## Set up your devices to work with AdGuard

 - For Android/Apple, go to WiFi advanced settings and select static option. In `DNS 1` field enter "Pi's IP" address

 <p align="center">
  <img src="https://i.imgur.com/nxpiqDw.jpg" width=450px height=580px>

 - For PC/Windows

    - <i>IPv4</i>

    Go to network settings / change adapter options and right click in properties then select "Internet Protocol Version 4(TCP/IPv4)". Enter Pi's IP address in `Preferred DNS` server.

    - <i>IPv6 (needed for `DoH` & `DoT` to work later on in guide if using IPv6 on your router)</i>

     Go to "Internet Protocol Version 6(TCP/IPv6)" Enter `::1`

`OPTIONAL:` <i>You can add a backup DNS in the alternative fields</i>
  
`BE AWARE:` <i>In android, adding a public DNS in second field breaks AdGuard ad blocking</i>

<p align="center">
 <img src="https://i.imgur.com/8gsDk3z.jpg">

## Setting up AdGuard blocklist

In AdGuard homepage under filters, select DNS blocklist section for adding URLs.

<p align="center">
 <img src="https://i.imgur.com/shrtJLD.png">

You can search Google for different blocklist. Here is my custom blocklist for example[<a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/blob/main/My-Blocklist.txt"><b>click here</b></a>]. Build your own from a list of main blocklist sources I collected[<a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/blob/main/%F0%9F%A7%B1Blocklist-Sources%E2%84%B9%EF%B8%8F"><b>click here</b></a>]. Or check out:
</br>
<a href="https://github.com/T145/black-mirror"><b>Tblack-mirror</b></a> - _***Automatically maintained malicious host blacklists and false-positive whitelists***_ 
</br>
👊BIG THANKS👊to <a href="https://github.com/T145"><b>T145</b></a>

`IMPORTANT:` Some blocklist can block some important contents or websites. To unblock go "Query Log" section and will see _unblock_ option when cursor is hovered over a query, putting unblocked websites it in "Custom filtering rules" example: `@@||bitly.com^$important`. Look for client IP & time.

## Add/Remove multiple URLs

You can only add one by one URL in DNS blocklist with AdGuard for now but there is a python script to add multiple URLs at once.

Open new py file(bulkurls.py) :
```
nano bulkurls.py
```  
 
Then copy and paste script configurations[<a href="https://raw.githubusercontent.com/trinib/Adguard-Wireguard-Unbound-Cloudflare/main/bulkurls.py"><b>click here</b></a>]. Set `your AdGuard credentials` and save (control+x then y then enter).
 
_If using **DietPi** install `sudo apt-get install python3-pip -y && pip install requests` for its not install by default._
  
To run : `sudo python3 bulkurls.py`

To **remove** you need to change `add` in <a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/blob/62ba01ed8ed3a5bc5294b9fe7ee38c3e83ae1b86/bulkurls.py#L150"><b>second of last line</b></a> to `remove` in bulkurls.py file.

Go to https://d3ward.github.io/toolz/adblock.html to test if ads are blocking <img src="https://i.imgur.com/Q5oO9EY.png" width=100px height=80px>

**[⬆ Return to contents ⬆](#table-of-contents)**

#
# <i>Install Unbound</b></i>

Run the following command in your terminal:
```
sudo apt install unbound -y
```
For recursively querying a host that is not cached as an address, the resolver needs to start at the top of the server tree and query the root servers, to know where to go for the top level domain for the address being queried. Unbound comes with default builtin hints.
```
wget -O root.hints https://www.internic.net/domain/named.root && sudo mv root.hints /var/lib/unbound/
```
 `IMPORTANT:` This needs to update every 6 months. To _**auto update**_ root.hints every 6 months you need to create a cron job.

Enter in command line `crontab -e`, it will ask select an editor(choose 1) and paste these lines at the bottom of crontab and save (control+x then y then enter):
```
1 0 1 */6 * wget -O root.hints https://www.internic.net/domain/named.root
2 0 1 */6 * sudo mv root.hints /var/lib/unbound/
```
_If using **DietPi** you need to install resolvconf and restart unbound-resolvconf.service to set unbound nameserver to 127.0.0.1 :_
```
sudo apt-get install resolvconf -y && sudo systemctl restart unbound-resolvconf.service
```  

<p align="center">
 <img src="https://i.imgur.com/26ro62t.jpg">

**[⬆ Return to contents ⬆](#table-of-contents)**

#    
# <i>Install Cloudflare</b></i>

## Setup for Cloudflared `(DoH)`
[<a href="https://github.com/trinib/Adguard-Wireguard-Unbound-Cloudflare/blob/main/Cloudflare-DoH-Setup.md"><b>click here</b></a>]</h4>

## Configure Cloudflare `(DoT)` on Unbound

Create unbound configuration file by entering in command prompt:
```
sudo nano /etc/unbound/unbound.conf.d/unbound.conf
```
And copy and paste all the text from this unbound.conf file[<a href="https://raw.githubusercontent.com/trinib/Adguard-Wireguard-Unbound-Cloudflare/main/unbound.conf"><b>click here</b></a>] and save (control+x then y then enter).

## Configure Stubby for Unbound

Use Unbound for caching and stubby as a TLS forwarder. Install stubby:
```
sudo apt install stubby -y
```
Remove and re-create stubby.yaml file:
```
cd /etc/stubby/ && sudo rm stubby.yml && sudo nano stubby.yml
```
And copy and paste all the text from this stubby config file[<a href="https://raw.githubusercontent.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/main/stubby.yml"><b>click here</b></a>] and save. (`cd` to return to home folder when finish).
* Restart unbound & stubby and check status:
```
sudo systemctl restart unbound stubby ; systemctl status unbound stubby -l
```
<p align="center">
 <img src="https://i.imgur.com/7zIpWP2.jpg" width=650px height=370px>

## Configure AdGuard with `Cloudflare(DoH&DoT)`

 * In AdGuard homepage under settings select "DNS settings"

 * Delete everything from "Upstream" and "Bootstrap DNS" server options and enter:

   * For `DNS over TLS(DoT)` add `127.0.0.1:53` in both "Upstream" and "Bootstrap DNS" server fields
   * For `DNS over HTTPS(DoH)` add `127.0.0.1:5053` in both "Upstream" and "Bootstrap DNS" server fields
   * For `TLS forwarder(stubby)` add `127.0.0.1:8053` in both "Upstream" and "Bootstrap DNS" server fields

* `IMPORTANT:` You need to check "<a href="https://adguard.com/en/blog/in-depth-review-adguard-home.html#dns"><b>Parallel Request</b></a>" option for DNS resolvers to work simultaneously.

<p align="center">
 <img src="https://i.imgur.com/Ug4Euou.jpg" width=650px height=370px>

 * Then in DNS setting look for DNS cache configuration section and set cache size to `0` (caching is already handled by the Unbound) and click apply.

<p align="center">
 <img src="https://i.imgur.com/8Q5Zb0M.jpg" width=650px height=370px>
 
<b>Click apply and test upstreams</b>(might get a error in the first testing only).

#### `IMPORTANT:` Windows system & Android browsers need some tweaking to `stabilize` DNS resolvers..Linux works fine<i>(tested on mint)</i>

### Windows 

 * Install Acrylic DNS Proxy: https://mayakron.altervista.org/support/acrylic/Home.htm

 * Go to `C:\Program Files (x86)\Acrylic DNS Proxy` and open `AcrylicConfiguration.ini` file. Delete everything and copy these settings[<a href="https://raw.githubusercontent.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/main/AcrylicConfiguration.ini"><b>click here</b></a>], only change _**PrimaryServerAddres**_ to your Pi's address.

 * In same folder run `RestartAcrylicService.bat` & `PurgeAcrylicCacheData.bat`

 `TIP:` Troubleshoot IP/DNS Commands
  ```
 ipconfig /release
 ipconfig /renew
 ipconfig /flushdns
  ```
### Android

 * In whatever browser you use, turn **off** `Use Secure DNS` option.
 
 * Be aware conflicts can occur with custom rooted roms&kernels with build.prop DNS tweaks or apps/Magisk module.

#### _Thats it_. Now go to https://1.1.1.1/help in browser and you should see these options output 'Yes'. 
 - [x] Connected to 1.1.1.1
 - [x] DNS over HTTPS(DoH)
 - [x] DNS over TLS(DoT)
 - [ ] DNS over WARP
 <p align="center">
  <img src="https://i.imgur.com/2S3IH5H.jpg" width=650px height=370px>

#### Other sites to check security
https://browserleaks.com/dns - should show all connected to "Cloudflare"

https://www.cloudflare.com/ssl/encrypted-sni/ - "Secure DNS / DNSSEC / TLS 1.3" should all be a green tick

https://dnssec.vs.uni-due.de/ - should say "Yes, your DNS resolver validates DNSSEC signatures"

**[⬆ Return to contents ⬆](#table-of-contents)**

#
# <i>Install WireGuard</b></i>

**Before installing WireGuard**, if you do not have a <a href="https://www.google.com/search?client=firefox-b-d&q=static+IP"><b>static IP</b></a> you need to get a free `Dynamic DNS Subdomain` or else your external IP address changes dynamically from your ISP so you'll need to set up a dynamic DNS service[**<a href="https://github.com/trinib/Adguard-Wireguard-Unbound-Cloudflare/blob/main/Dns-Service-Guide.md"><b>click here</b></a>**]. Or else skip the step.

You also need to set up <a href="https://www.google.com/search?q=What+is+port+forwarding+used+for%3F&client=firefox-b-d&sxsrf=APq-WBuwPqGlPJ6N9_l6qpQ3e5sYoUxZAQ%3A1650219365125&ei=ZVlcYo6sB6SGwbkP8tGOwA8&ved=0ahUKEwjO8ryY2pv3AhUkQzABHfKoA_gQ4dUDCA0&uact=5&oq=What+is+port+forwarding+used+for%3F&gs_lcp=Cgdnd3Mtd2l6EAMyBggAEBYQHjoHCAAQRxCwAzoHCAAQsAMQQ0oECEEYAEoECEYYAFDMAVjMAWCBBWgBcAF4AIABbIgBbJIBAzAuMZgBAKABAqABAcgBCsABAQ&sclient=gws-wiz"><b>port forwarding</b></a> on your router so you can access WireGuard outside of our network like in a coffee shop hotspot or your mobile data.
TYPE | VALUE     
------------ | -------------
Device | Raspberry Pi's hostname or IP
Protocol | UDP
Port range | 51820-51820
Outgoing port | 51820
Permit Internet access(if have) | yes 

My 👇router👇 port setting. Yours maybe different but you'll get it. Remember Google 🔍search engine🔎 is your friend. If you cannot connect from a outside network that means ISP has blocked outgoing connections, you can call them and ask nicely to get it working.

<p align="center">
 <img src="https://i.imgur.com/9LBEk1i.jpg">

***
👊BIG THANKS👊 for this installation script from <a href="https://github.com/Nyr/wireguard-install"><b>Nyr</b></a>. Follow to keep updated.

Run in terminal 
```
wget https://git.io/wireguard -O wireguard-install.sh && sudo bash wireguard-install.sh
```
 * The script is going to ask you for Public IPv4/hostname for the VPN. _If_ you have static IP then continue or else type the dynamic DNS domain that you created from the <a href="https://github.com/trinib/Adguard-Wireguard-Unbound-Cloudflare/blob/main/Dns-Service-Guide.md"><b>instructions</b></a>. For example:trinibvpn.freeddns.org

 * For port option `press enter` for default 51820. For client name, just put any name you want, and for DNS use option 3 (`1.1.1.1`) for now. You will configure `AdGuard/Unbound/Cloudflare` with the VPN after its finished installed.

<p align="center">
 <img src="https://i.imgur.com/WUNZIK4.jpg">

 * Wait until the installation is finished and QR code to show, don't close. But if you do, to `regenerate qrcode`, enter in terminal but replacing just the name `yourclientname.conf` file to yours: 
```
sudo cp /root/yourclientname.conf /home/pi && sudo qrencode -t ansiutf8 < yourclientname.conf
```
`IMPORTANT:` You will need to add a new user/client for each device you use with the VPN. To add a new user, simply re-run the script and create user with different client name.

<b>Use _OpenVPN_</b>[<a href="https://github.com/trinib/Adguard-Wireguard-Unbound-Cloudflare/blob/main/OpenVPN-Setup.md"><b>click here</b></a>]

#
### Connecting VPN To Android/IOS Phone

Install the WireGuard app from Google Play or App Store:

WireGuard (Google Play): https://play.google.com/store/apps/details?id=com.wireguard.android

WireGuard (App Store): https://apps.apple.com/us/app/wireguard/id1441195209

You need to scan the QR code shown in the terminal with WireGuard app, select the `+ button` and use the option `Scan from QR code` to install configuration.

`IMPORTANT`: Enable **kernel module backend** in settings

<p align="left">
 <img src="https://i.imgur.com/R4qbiOQ.jpg" width=250px height=350px>

### Connecting VPN to Windows

WireGuard for windows: https://download.wireguard.com/windows-client/wireguard-installer.exe

 * Create a `new text document` with any name on PV to copy&paste the text from WireGuard client configuration file.

 * To see text in client config file, type in terminal:
```
sudo cat /root/yourclientname.conf
```
 * Highlight all the text, copy and paste it in the txt file on PC and save. Then rename the extension from `txt` to `conf`. Now you have config file for that WireGuard client.

 * You can now import the config file to WireGuard (import from file option).

## Configure WireGuard with `Adguard/Unbound/Cloudflare`

_Remember this is for when you are connected to WireGuard VPN on an outside network or at home 24/7 cause you already have AdGuard/Unbound/Cloudflare set up and running on your devices manually._ (no issue having both set up fro my experience)
 * In WireGuard app, select your tunnel and select edit (pencil on top right)

 * Under DNS servers enter `Pi's IP` and save (IPv4 & IPv6)

<p align="center">
 <img src="https://i.imgur.com/UC0vWfE.jpg" width=450px height=500px>  

 ### Limit traffic

With WireGuard you will lose about 50% of internet speed cause the process of tunneling through Pi to router to devices**

Delete in allowed IPs "0.0.0.0/0, ::/0" option because it routes all traffic to your home network which will be slow. You need send traffic through your addresses only.

 * First you need to replace it with your network gateway but setting the last number to a zero and <a href="https://www.google.com/search?q=prefix+length+explained&client=firefox-b-d&sxsrf=ALeKk036Jc9vJl73zVXf0yyZs5UlKRlNRQ%3A1621083125589&ei=9cOfYI66I5-qwbkPkdWxkAk&oq=prefix+length+explained&gs_lcp=Cgdnd3Mtd2l6EAMyBggAEAcQHjoHCCMQsAMQJzoHCAAQRxCwA1CUJ1iUJ2CiKmgBcAJ4AIABsAGIAdQCkgEDMC4ymAEAoAEBqgEHZ3dzLXdpesgBCcABAQ&sclient=gws-wiz&ved=0ahUKEwjOiOie3cvwAhUfVTABHZFqDJIQ4dUDCA0&uact=5"><b>prefix length</b></a> to 24. For example: `192.168.1.1/24` to `192.168.1.0/24` or like my ISP router `192.168.100.1/24` to `192.168.100.0/24`. ~~**Now I only lose 25% speed**😁 (PS. using 5g network)~~ 

`UPDATE:` After a WireGuard update I do not get a faster speed doing this😞 .. but it still makes sense _not_ to use `"0.0.0.0/0, ::/0` with WiFi. If anyone knows any tweaks to get a boost, let me know.

<p align="center">
 <img src="https://i.imgur.com/x4m6Pbl.jpg" width=450px height=500px>

### PLEASE READ !! , BE AWARE !! 
`IMPORTANT`: _If your network has IP addresses for devices that ends with a 3 digit number (more than 24), for example: 192.168.100.`254`, you will not be able to route properly from outside network because applying 24 only allows numbers 1 through 24. You need to instead put `0` to route out of the 24 range, for example : `192.168.100.0/0`_. 

Or you can change IP range on your router (in my experience you might get a tiny bit better speeds cause it will not route unnecessary allowed IP addresses over the 24 range).
<p align="center">
 <img src="https://i.imgur.com/ZZ4aMUI.jpg" width=750px height=550px>

## IPv6
If you are using IPv6, when connected to WiFi you need to enter in WireGuard allowed IPs `fe80::1/0` as well. For example `192.168.100.0/0, fe80::1/0`

When connected to Ethernet cable on a windows PC, you need to enter `::1` in IPv6 address in "Internet Protocol Version 6(TCP/IPv6)" preferred DNS server.

Then go to https://ipv6leak.com/ and you should see "_Your IPv6 is not leaking_".
#
 
## Disable all IPv6

#### Disable IPv6 if you don't have it or don't want it[<a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/blob/main/Disable-All-IPv6.md"><b>click here</b></a>]. In result if you have weak internet, disabling IPv6 can speed up dns request but have less security.

#
## Test VPN

How do you know if WireGuard VPN is really working?

For **windows** download Wireshark: https://www.wireshark.org/#download

Once downloaded you can use the application to inspect your data packets where the protocol is set to the one used by WireGuard VPN. When a packet traffic is `encrypted`, it can be read  like this for example:
<p align="center">
 <img src="https://i.imgur.com/Tn4M47R.jpg">

For **android** you can use PCAPdroid: https://play.google.com/store/apps/details?id=com.emanuelef.remote_capture&hl=en&gl=US
                                                                                                                                
You should see all connections `closed` and status showing all DNS and not any TLS connections in all apps. (open and use apps for PCAPdroid to scan)

**[⬆ Return to contents ⬆](#table-of-contents)**

***

#
# <i>Auto Update Pi</b></i>

Open new sh file called update and copy&paste script[<a href="https://raw.githubusercontent.com/trinib/Adguard-Wireguard-Unbound-Cloudflare/main/update.sh"><b>click here</b></a>]
```
sudo nano update.sh
```
Set permission
```
sudo chmod 700 update.sh
```
Open cron file by entering in command line `crontab -e`, copy&paste job command line below at the bottom of cron file and save.
```
0 3 * * WED sudo ./update.sh 2>&1 >/home/pi/updatelog
```
Pi will now update every Wednesday at 3am. Or you can go to https://crontab.guru/ and set your own time schedule.

Adjust Pi's date/timezone enter in terminal:
```
sudo dpkg-reconfigure tzdata
```
or set manually
```
sudo date -s "25 DEC 2012 11:14:00"
```
#
# <i>Install Log2Ram</b></i>

One of the most significant advantages of offloading your RAM is that it improves your **SD Card’s potential lifespan**.
Log files are one of the things written to most by the various pieces of software you install.
By pushing the files to your RAM, you can control how often they are written to the SD Card. You will still be able to access these files on the RAM as if they sat on your SD Card.

Copy and paste this line in terminal:
 
Manually
```
wget https://git.io/log2ram -O Log2Ram-Script.sh && sudo chmod +x Log2Ram-Script.sh && sudo ./Log2Ram-Script.sh
```
or

Add repo source(auto update)
```
echo "deb [signed-by=/usr/share/keyrings/azlux-archive-keyring.gpg] http://packages.azlux.fr/debian/ bullseye main" | sudo tee /etc/apt/sources.list.d/azlux.list
sudo wget -O /usr/share/keyrings/azlux-archive-keyring.gpg  https://azlux.fr/repo.gpg
sudo apt update
sudo apt install log2ram
```
#
# <i>Turn off Pi LED lights</b></i>

I guess power to LEDs will impact unnecessary electricity and heat 🤷😅. No need for it anyways if just using it as a network server. Open cron file by entering in command line `crontab -e`, copy&paste job command line below at the bottom of cron file and save.

Green 
```
@reboot echo none | sudo tee /sys/class/leds/led0/trigger
 ```   
Red
```
@reboot echo none | sudo tee /sys/class/leds/led1/trigger
```
Reboot Pi.

#
# <i>Secure your Raspberry Pi</b></i>
<p align="center">
<a href="https://gist.github.com/boseji/c9e91ff3bd0b3cfb62a5e260fe505374"><img src="https://i.imgur.com/a9JQVls.png" width=80px height=90px></a>

[<a href="https://gist.github.com/boseji/c9e91ff3bd0b3cfb62a5e260fe505374"><b>click here</b></a>]

<i>( I just use Fail2Ban and change SSH port )</i>

**[⬆ Return to contents ⬆](#table-of-contents)**

***

<b>ANY ISSUES, FIXES OR TIPS TO MAKE THESE PROJECTS BETTER PLEASE CONTRIBUTE🤖</b>

***

<p align="center">
<img src="https://user-images.githubusercontent.com/73097560/115834477-dbab4500-a447-11eb-908a-139a6edaec5c.gif"
<br> 
<br> 
<br> 

<p align="center">
 <img src="https://i.imgur.com/Q07E7SW.gif" width=500px height=30px>

<p align="center">
<a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/stargazers"><img src="https://reporoster.com/stars/dark/trinib/AdGuard-WireGuard-Unbound-Cloudflare"></a>

<p align="center">
<img src="https://user-images.githubusercontent.com/73097560/115834477-dbab4500-a447-11eb-908a-139a6edaec5c.gif"</p>

#

## _Repository Resources_

<h5 https://www.raspberrypi.com/documentation/

https://github.com/AdguardTeam/AdGuardHome/wiki/Getting-Started

https://developers.cloudflare.com/

https://docs.pi-hole.net/guides/dns/cloudflared/

https://docs.pi-hole.net/guides/dns/unbound/

https://nlnetlabs.nl/documentation/unbound/unbound.conf/

https://dnsprivacy.org/dns_privacy_clients/
    
https://github.com/anudeepND/pihole-unbound

https://github.com/stong/unbound.conf.d

https://github.com/Nyr/wireguard-install 
    
https://github.com/azlux/log2ram
    
https://github.com/T145/black-mirror

---
