# ![logo](https://i.imgur.com/zqJELkl.png)

<p align="center">
 <img src="https://img.shields.io/badge/License-MIT-blue.svg">
 <img src="https://badges.frapsoft.com/os/v3/open-source.svg?v=103">
 <img src="http://ForTheBadge.com/images/badges/built-with-love.svg">
 <img src="https://img.shields.io/badge/badges-awesome-green.svg">
 <img src="https://img.shields.io/badge/Stay-Safe-red?logo=data:image/svg%2bxml;base64,PHN2ZyBpZD0iTGF5ZXJfMSIgZW5hYmxlLWJhY2tncm91bmQ9Im5ldyAwIDAgNTEwIDUxMCIgaGVpZ2h0PSI1MTIiIHZpZXdCb3g9IjAgMCA1MTAgNTEwIiB3aWR0aD0iNTEyIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxnPjxnPjxwYXRoIGQ9Im0xNzQuNjEgMzAwYy0yMC41OCAwLTQwLjU2IDYuOTUtNTYuNjkgMTkuNzJsLTExMC4wOSA4NS43OTd2MTA0LjQ4M2g1My41MjlsNzYuNDcxLTY1aDEyNi44MnYtMTQ1eiIgZmlsbD0iI2ZmZGRjZSIvPjwvZz48cGF0aCBkPSJtNTAyLjE3IDI4NC43MmMwIDguOTUtMy42IDE3Ljg5LTEwLjc4IDI0LjQ2bC0xNDguNTYgMTM1LjgyaC03OC4xOHYtODVoNjguMThsMTE0LjM0LTEwMC4yMWMxMi44Mi0xMS4yMyAzMi4wNi0xMC45MiA0NC41LjczIDcgNi41NSAxMC41IDE1LjM4IDEwLjUgMjQuMnoiIGZpbGw9IiNmZmNjYmQiLz48cGF0aCBkPSJtMzMyLjgzIDM0OS42M3YxMC4zN2gtNjguMTh2LTYwaDE4LjU1YzI3LjQxIDAgNDkuNjMgMjIuMjIgNDkuNjMgNDkuNjN6IiBmaWxsPSIjZmZjY2JkIi8+PHBhdGggZD0ibTM5OS44IDc3LjN2OC4wMWMwIDIwLjY1LTguMDQgNDAuMDctMjIuNjQgNTQuNjdsLTExMi41MSAxMTIuNTF2LTIyNi42NmwzLjE4LTMuMTljMTQuNi0xNC42IDM0LjAyLTIyLjY0IDU0LjY3LTIyLjY0IDQyLjYyIDAgNzcuMyAzNC42OCA3Ny4zIDc3LjN6IiBmaWxsPSIjZDAwMDUwIi8+PHBhdGggZD0ibTI2NC42NSAyNS44M3YyMjYuNjZsLTExMi41MS0xMTIuNTFjLTE0LjYtMTQuNi0yMi42NC0zNC4wMi0yMi42NC01NC42N3YtOC4wMWMwLTQyLjYyIDM0LjY4LTc3LjMgNzcuMy03Ny4zIDIwLjY1IDAgNDAuMDYgOC4wNCA1NC42NiAyMi42NHoiIGZpbGw9IiNmZjRhNGEiLz48cGF0aCBkPSJtMjEyLjgzIDM2MC4xMnYzMGg1MS44MnYtMzB6IiBmaWxsPSIjZmZjY2JkIi8+PHBhdGggZD0ibTI2NC42NSAzNjAuMTJ2MzBoMzYuMTRsMzIuMDQtMzB6IiBmaWxsPSIjZmZiZGE5Ii8+PC9nPjwvc3ZnPg==">

</p>
 <p align="center">
     <a href="https://img.shields.io/github/stars/trinib/AdGuard-WireGuard-Unbound-Cloudflare?color=FFD700&style=for-the-badge" alt="GitHub Repo stars">
         <img src="https://img.shields.io/github/stars/trinib/AdGuard-WireGuard-Unbound-Cloudflare?color=FFD700&style=for-the-badge"></a>
     <a href="https://img.shields.io/github/forks/trinib/AdGuard-WireGuard-Unbound-Cloudflare?color=00a671&style=for-the-badge" alt="GitHub forks">
         <img src="https://img.shields.io/github/forks/trinib/AdGuard-WireGuard-Unbound-Cloudflare?color=00a671&style=for-the-badge"></a>
     <a href="https://img.shields.io/github/watchers/trinib/AdGuard-WireGuard-Unbound-Cloudflare?color=9700b2&style=for-the-badge" alt="GitHub watchers">
         <img src="https://img.shields.io/github/watchers/trinib/AdGuard-WireGuard-Unbound-Cloudflare?color=9700b2&style=for-the-badge"></a>
</p>

<h2><p align="center">
<a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/blob/lang/README.zh-CN.md"><b>🇨🇳</b></a>&nbsp;<a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/blob/lang/README.es.md"><b>🇪🇸</b></a>&nbsp;<a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/blob/lang/README.ru.md"><b>🇷🇺</b></a>&nbsp;<a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/blob/lang/README.hi.md"><b>🇮🇳</b></a>&nbsp;<a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/blob/lang/README.fr.md"><b>🇫🇷</b></a>&nbsp;<a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/blob/lang/README.it.md"><b>🇮🇹</b></a>&nbsp;<a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/blob/lang/README.de.md"><b>🇩🇪</b></a>&nbsp;<a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/blob/lang/README.ar.md"><b>🇦🇪</b></a></h2>

<p align="center"><img src="https://raw.githubusercontent.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/main/assets/images/awcu.gif" width= "700">

# 

## 特征

#### _<a href="https://github.com/AdguardTeam/AdGuardHome/blob/master/README.md"><b>AdGuard 主页</b></a>_：在您的所有设备上屏蔽广告（<a href="https://github.com/AdguardTeam/AdGuardHome/blob/master/README.md#how-does-adguard-home-compare-to-pi-hole"><b>_与 Pi-Hole 相比_</b></a>)

#### _<a href="https://www.wireguard.com/"><b>线卫</b></a>_：可从任何外部网络访问家中的 VPN 服务器（IPv4 和 IPv6）

#### <a href="https://www.nlnetlabs.nl/projects/unbound/about/"><b><i>未绑定</i></b></a>和[<i>粗短</i>](https://dnsprivacy.org/dns_privacy_daemon_-_stubby/about_stubby/): 一个验证的、递归的、缓存的 DNS 解析器

#### _<a href="https://www.cloudflare.com/learning/what-is-cloudflare/"><b>Cloudflare</b></a>_: 浏览网站时更好的性能和安全性(DoT & DoH)

<i>所有软件都是免费、开源和 自托管 </i></br><a href="https://git.io/About"><b>关于</b></a>\|<a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/discussions/17"><b>常问问题</b></a>                              

* * *

### DNS查询速度与<a href="https://docs.oracle.com/en-us/iaas/Content/DNS/Tasks/testingdnsusingdig.htm"><b>BIND的挖掘工具</b></a>🧪

<b>google.com 的结果（以毫秒为单位）：</b>

-   AdGuard 默认 DNS 解析器 -`60-70 msec`
-   公共 Cloudflare/Quad9/Google DNS 解析器 -`50-70 msec`
-   此设置/配置 -`5-10 msec`

<details><summary><b>Preview🎥<img src="https://media.giphy.com/media/WT5h7PgVSScLLKtMaS/giphy.gif" width=50px height=40px></b></summary>
<p>

AdGuard 默认 DNS<b><i>对比</i></b>这个设置⭐：

[HTTPS://user-images.GitHub user content.com/18756975/150230438-不767哦86发-4哦18-4791-不5份额-0813615啊37啊3.门票4](https://user-images.githubusercontent.com/18756975/150230438-b767e86f-4e18-4791-b5fe-0813615a37a3.mp4)

公共 Cloudflare/Quad9/Google DNS 解析器：

[HTTPS://user-images.GitHub user content.com/18756975/150319049-3的8ACD C9-624发-4不60-8哦哦2-不80227522252.门票4](https://user-images.githubusercontent.com/18756975/150319049-3d8acdc9-624f-4b60-8ee2-b80227522252.mp4)

</p>
</details>

* * *

### 最后检查⏰：2022 年 4 月 17 日</h2>

<div align="center">

|                             项目                             |                           地位                           |
| :--------------------------------------------------------: | :----------------------------------------------------: |
|                         AdGuard 主页                         |                            ✅                           |
|                             未绑定                            |                            ✅                           |
|                         Cloudflare                         |                            ✅                           |
|                             粗短                             |                            ✅                           |
|                             线卫                             |                            ✅                           |

</div>

# 目录

-   [要求](#requirements)
-   [安装树莓派操作系统](#install-raspberry-pi-os)<img src="https://www.vectorlogo.zone/logos/raspberrypi/raspberrypi-icon.svg" width=20px height=20px>
    -   [使用 SSH 访问 Pi OS](#access-pi-os-with-ssh)
-   [安装 AdGuard 主页](#install-adguard-home)<img src="https://www.vectorlogo.zone/logos/adguard/adguard-icon.svg" width=20px height=20px>
    -   [设置您的设备以使用 Adguard](#set-up-your-devices-to-work-with-adguard)
    -   [设置 AdGuard 阻止列表](#setting-up-adguard-blocklist)
        -   [添加/删除多个 URL](#addremove-multiple-urls)
-   [安装未绑定](#install-unbound)<img src="https://www.privacytools.io/img/apps/unbound.svg" width=20px height=20px>
-   [安装 Cloudflare](#install-cloudflare)<img src="https://www.vectorlogo.zone/logos/cloudflare/cloudflare-icon.svg" width=20px height=20px>
    -   [Cloudflared (DoH) 的设置](#setup-for-cloudflared-doh)
    -   [在 Unbound 上配置 Cloudflare (DoT)](#configure-cloudflare-dot-on-unbound)
        -   [为未绑定配置 Stubby](#configure-stubby-for-unbound)
        -   [使用 Cloudflare (DoH&DoT) 配置 AdGuard](#configure-adguard-with-cloudflaredohdot)
-   [安装 WireGuard](#install-wireguard)<img src="https://www.vectorlogo.zone/logos/wireguard/wireguard-icon.svg" width=20px height=20px>或者<a href="https://github.com/trinib/Adguard-Wireguard-Unbound-Cloudflare/blob/main/OpenVPN-Setup.md">OpenVPN（较慢）</a><img src="https://i.imgur.com/Agstbe5.png" width=20px height=20px>
-   [将 VPN 连接到 Android/IOS 手机](#connecting-vpn-to-androidios-phone)
-   [将 VPN 连接到 Windows](#connecting-vpn-to-windows)
-   [使用 AdGuard/Unbound/Cloudflare 配置 Wireguard](#configure-wireguard-with-adguardunboundcloudflare)
    -   [限制流量](#limit-traffic)
    -   [Ипвш](#ipv6)
    -   [禁用所有 IPv6](#disable-all-ipv6)
-   [测试VPN](#test-vpn)<img src="https://i.imgur.com/6Yf8Zra.png" width=20px height=20px>
-   [自动更新 Pi](#auto-update-pi)
-   [安装 Log2ram](#install-log2ram)
-   [关闭 Pi LED](#turn-off-pi-led-lights)
-   [保护您的树莓派](#secure-your-raspberry-pi)
-   [存储库资源](#repository-resources)

# 

# 要求

本教程基于 Raspberry Pi，但您可以使用任何 Linux<a href="https://github.com/thibmaek/awesome-raspberry-pi#os-images"><b>操作系统</b></a><i>（少量）</i>，任何硬件或<a href="https://www.google.com/search?q=What+is+a+VPS+used+for%3F&client=firefox-b-d&biw=1280&bih=582&sxsrf=APq-WBu-yng0bW9IWwNKsQhD6h1ZmRGncw%3A1650151372793&ei=zE9bYpL1L_OOwbkPgZ6DGA&ved=0ahUKEwiSi5rz3Jn3AhVzRzABHQHPAAMQ4dUDCA0&uact=5&oq=What+is+a+VPS+used+for%3F&gs_lcp=Cgdnd3Mtd2l6EAMyBAgAEA0yBAgAEA0yBAgAEA0yBAgAEA0yBggAEA0QHjIGCAAQFhAeMgYIABAWEB4yCAgAEAgQDRAeMggIABAIEA0QHjIICAAQCBANEB46BwgAEEcQsANKBAhBGABKBAhGGABQ8AFY8AFg_ANoAXABeACAAXCIAXCSAQMwLjGYAQCgAQKgAQHIAQjAAQE&sclient=gws-wiz"><b>虚拟主机</b></a>.</br>（Raspberry Pi OS 最简单，推荐给 Pi 或更有经验的用户，<b>饮食派</b>操作系统也推荐）

-   Raspberry Pi 3 或 4 版本
-   支持端口转发的路由器（大多数可以）
-   MicroSD USB 读卡器
-   MicroSD 卡（8GB 或更大，至少 Class 4）
-   以太网电缆
-   （如果使用显示器，则可选）MicroHDMI-(RPi 4) 或 HDMI-(RPi 3)

# 

# <i>安装树莓派操作系统</b></i>

Raspberry Pi OS 有桌面版和精简版（使用精简版<a href="https://www.google.com/search?q=What+is+a+headless+operating+system%3F&client=firefox-b-d&sxsrf=APq-WBvlqMZasn_klYxS5HZmhKQlduKYuQ%3A1650123816301&ei=KORaYtz7EYOdwbkP74G16AE&ved=0ahUKEwjcr5-f9pj3AhWDTjABHe9ADR0Q4dUDCA0&uact=5&oq=What+is+a+headless+operating+system%3F&gs_lcp=Cgdnd3Mtd2l6EAMyCAghEBYQHRAeOgcIABBHELADSgQIQRgASgQIRhgAUMEBWMEBYNAEaAFwAXgAgAFqiAFqkgEDMC4xmAEAoAECoAEByAEIwAEB&sclient=gws-wiz"><b>无头</b></a>模式）。您可以使用显示器/键盘/鼠标访问 Raspberry Pi 或通过以下方式连接<a href="https://www.google.com/search?q=linux+ssh+&client=firefox-b-d&sxsrf=APq-WBve72uwEMMqUAe77nZoaygcx-ROMg%3A1650123667623&ei=k-NaYtbfJbmvwbkPpf6nqAQ&ved=0ahUKEwiW9azY9Zj3AhW5VzABHSX_CUUQ4dUDCA0&uact=5&oq=linux+ssh+&gs_lcp=Cgdnd3Mtd2l6EAMyBAgjECcyBQgAEIAEMgUIABCRAjIFCAAQkQIyBQgAEIAEMgUIABCABDIFCAAQkQIyBQgAEIAEMgUIABCABDIFCAAQgAQ6BwgAEEcQsANKBAhBGABKBAhGGABQuAFY0AJg1AZoAXABeACAAXaIAeIBkgEDMC4ymAEAoAEByAEIwAEB&sclient=gws-wiz"><b>SSH</b></a>从一个终端。

安装 balenEtcher 并下载 Pi 映像以写入 microSD 卡。

-   下载树莓派操作系统：[HTTPS://呜呜呜.raspberry皮.org/software/operating-systems/](https://www.raspberrypi.org/software/operating-systems/)

-   下载balenaEtcher：[HTTPS://呜呜呜.拔了那.IO/etcher/](https://www.balena.io/etcher/)

在你拥有之后`Etcher`安装和`Raspberry Pi OS`下载文件后，您现在可以将带有 microSD USB 读卡器的 SD 卡插入计算机。

-   启动 Etcher 并选择您下载的 Raspberry Pi OS 映像，选择您的 microSD 卡并单击`Flash`.

刷机完成后，在“This PC”中查找磁盘名称“boot or USB drive”（如果没有看到，请重新插入 USB 读卡器）。转到该磁盘，创建一个名为的新文本文件**_`ssh without 'txt' extension`_**.如果看不到，请在文件资源管理器选项中禁用“隐藏已知文件类型的扩展名”。

<p align="center">
 <img src="https://i.imgur.com/eV6uMbz.jpg">

<i>将 SD 卡放入 Raspberry Pi，插入以太网电缆并启动</i>

## 使用 SSH 访问 Pi OS

-   等待 Pi 首次启动

-   打开浏览器并登录路由器的面板页面

-   查找连接到您的网络的所有设备的列表并复制 Raspberry Pi 的 IP 地址（它很可能有主机名`raspberrypi`)

-   在主机上打开终端。您可以在 Windows 上使用 powerShell 或在 Android 上使用 RaspController。

键入以下命令：

    ssh pi@pi's IP address

<i>您可以使用鼠标右键在 Windows powerShell 中粘贴文本</i>.

指纹问题输入“yes”，默认密码输入“raspberry”（密码在命令行中不可见）。你可以输入**_`sudo passwd pi`_**后更改密码。

<p align="center">
 <img src="https://i.imgur.com/Wf30jxG.jpg">

在终端中运行：

    sudo apt update -y && sudo apt upgrade -y

__完成后重启__

    sudo reboot

**[⬆ 返回内容⬆](#table-of-contents)**

# 

# <i>安装 AdGuard 主页</b></i>

这个安装脚本来自<a href="https://github.com/AdguardTeam/AdGuardHome/blob/master/README.md"><b>AdGuard 主页</b></a>主要项目。关注以保持更新。

在终端中运行以下命令：

    curl -s -S -L https://raw.githubusercontent.com/AdguardTeam/AdGuardHome/master/scripts/install.sh | sh -s -- -v

-   安装完成后，终端会弹出一个窗口显示`links`到您的 AdGuard 主页（开始使用）

-   `IMPORTANT:`在 Listen Interfaces 选项中选择`Eth0`然后选择下一步

    <p align="center">
     <img src="https://i.imgur.com/Wa00lDp.jpg" width=580px height=690px>

-   设置用户名和密码并登录到管理面板

-   `IMPORTANT:`在常规设置中，将“查询日志保留”设置为`24 hours`. （我读到对于某些人来说，日志已满，这会减慢 Pi 并需要重新启动）

## 设置您的设备以使用 AdGuard

-   对于 Android/Apple，请转到 WiFi 高级设置并选择静态选项。在`DNS 1`字段输入“Pi的IP”地址

    <p align="center">
     <img src="https://i.imgur.com/nxpiqDw.jpg" width=450px height=580px>

-   适用于 PC/Windows

    -   <i>Ипвч</i>

        转到网络设置/更改适配器选项并右键单击属性，然后选择“Internet 协议版本 4（TCP/IPv4）”。输入 Pi 的 IP 地址`Preferred DNS`服务器。

    -   <i>IPv6（需要`DoH`&`DoT`如果在路由器上使用 IPv6，请稍后在指南中工作）</i>

        转到“Internet 协议版本 6（TCP/IPv6）”输入`::1`

`OPTIONAL:`<i>您可以在替代字段中添加备用 DNS</i>

`BE AWARE:`<i>在 android 中，在第二个字段中添加公共 DNS 会破坏 AdGuard 广告拦截</i>

<p align="center">
 <img src="https://i.imgur.com/8gsDk3z.jpg">

## 设置 AdGuard 阻止列表

在 AdGuard 主页的过滤器下，选择 DNS 阻止列表部分以添加 URL。

<p align="center">
 <img src="https://i.imgur.com/shrtJLD.png">

例如我的黑名单[<a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/blob/main/My-Blocklist.txt"><b>点击这里</b></a>]

**_终极黑名单来源_**:</br><img src="https://raw.githubusercontent.com/T145/black-mirror/master/.github/images/logo.png" width=30%>  
<a href="https://github.com/T145/black-mirror"><b>黑镜子</b></a>-_自动维护恶意主机黑名单和误报白名单_</br>👊非常感谢👊<a href="https://github.com/T145"><b>145</b></a>

`IMPORTANT:`一些阻止列表可以阻止一些重要的内容或网站。要取消阻止，请转到“查询日志”部分，然后会看到_解除封锁_当光标悬停在查询上时的选项，将未阻止的网站放在“自定义过滤规则”示例中：`@@||bitly.com^$important`.查找客户端 IP 和时间。

## 添加/删除多个 URL

您现在只能使用 AdGuard 在 DNS 阻止列表中添加一个 URL，但是有一个 python 脚本可以一次添加多个 URL。

打开新的 py 文件（bulkurls.py）：

    nano bulkurls.py

然后复制粘贴脚本配置[<a href="https://raw.githubusercontent.com/trinib/Adguard-Wireguard-Unbound-Cloudflare/main/bulkurls.py"><b>点击这里</b></a>].放`your AdGuard credentials`并保存（control+x 然后 y 然后输入）。

_如果使用**饮食派**安装`sudo apt-get install python3-pip -y && pip install requests`因为它默认不安装。_

跑步 ：`sudo python3 bulkurls.py`

到**消除**你需要改变`add`在<a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/blob/62ba01ed8ed3a5bc5294b9fe7ee38c3e83ae1b86/bulkurls.py#L150"><b>最后一行的第二个</b></a>到`remove`在 bulkurls.py 文件中。

去[HTTPS://的3Ward.GitHub.IO/too LZ/AD block.HTML](https://d3ward.github.io/toolz/adblock.html)测试广告是否被屏蔽<img src="https://i.imgur.com/Q5oO9EY.png" width=100px height=80px>

**[⬆ 返回内容⬆](#table-of-contents)**

# 

# <i>安装未绑定</b></i>

在终端中运行以下命令：

    sudo apt install unbound -y

为了递归查询未缓存为地址的主机，解析器需要从服务器树的顶部开始并查询根服务器，以了解要查询的地址的顶级域的去向。 Unbound 带有默认的内置提示。

    wget -O root.hints https://www.internic.net/domain/named.root && sudo mv root.hints /var/lib/unbound/

`IMPORTANT:`这需要每 6 个月更新一次。到_**自动更新**_root.hints 每 6 个月你需要创建一个 cron 作业。

在命令行中输入`crontab -e`，它会要求选择一个编辑器（选择 1）并将这些行粘贴到 crontab 的底部并保存（control+x 然后 y 然后输入）：

    1 0 1 */6 * wget -O root.hints https://www.internic.net/domain/named.root
    2 0 1 */6 * sudo mv root.hints /var/lib/unbound/

_如果使用**饮食派**您需要安装 resolvconf 并重新启动 unbound-resolvconf.service 以将 unbound nameserver 设置为 127.0.0.1 ：_

    sudo apt-get install resolvconf -y && sudo systemctl restart unbound-resolvconf.service

<p align="center">
 <img src="https://i.imgur.com/26ro62t.jpg">

**[⬆ 返回内容⬆](#table-of-contents)**

# 

# <i>安装 Cloudflare</b></i>

## Cloudflared 的设置`(DoH)`

[<a href="https://github.com/trinib/Adguard-Wireguard-Unbound-Cloudflare/blob/main/Cloudflare-DoH-Setup.md"><b>点击这里</b></a>]</h4>

## 配置 Cloudflare`(DoT)`在未绑定

通过在命令提示符下输入来创建未绑定的配置文件：

    sudo nano /etc/unbound/unbound.conf.d/unbound.conf

并复制并粘贴此 unbound.conf 文件中的所有文本[<a href="https://raw.githubusercontent.com/trinib/Adguard-Wireguard-Unbound-Cloudflare/main/unbound.conf"><b>点击这里</b></a>]并保存（control+x 然后 y 然后输入）。

## 为未绑定配置 Stubby

使用 Unbound 进行缓存并使用 stubby 作为 TLS 转发器。安装粗短：

    sudo apt install stubby -y

删除并重新创建 stubby.yaml 文件：

    cd /etc/stubby/ && sudo rm stubby.yml && sudo nano stubby.yml

并复制并粘贴此 stubby 配置文件中的所有文本[<a href="https://raw.githubusercontent.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/main/stubby.yml"><b>点击这里</b></a>]并保存。 (`cd`完成后返回主文件夹）。

重启 unbound & stubby 并检查状态：

    sudo systemctl restart unbound stubby ; systemctl status unbound stubby -l

<p align="center">
 <img src="https://i.imgur.com/7zIpWP2.jpg" width=650px height=370px>

## 配置 AdGuard`Cloudflare(DoH&DoT)`

-   在 AdGuard 主页的设置下选择“DNS 设置”

-   从“Upstream”和“Bootstrap DNS”服务器选项中删除所有内容并输入：

    -   为了`DNS over TLS(DoT)`添加`127.0.0.1:53`在“上游”和“引导 DNS”服务器字段中
    -   为了`DNS over HTTPS(DoH)`添加`127.0.0.1:5053`在“上游”和“引导 DNS”服务器字段中
    -   为了`TLS forwarder(stubby)`添加`127.0.0.1:8053`在“上游”和“引导 DNS”服务器字段中

-   `IMPORTANT:`你需要检查“<a href="https://adguard.com/en/blog/in-depth-review-adguard-home.html#dns"><b>并行请求</b></a>" DNS 解析器同时工作的选项。

<p align="center">
 <img src="https://i.imgur.com/Ug4Euou.jpg" width=650px height=370px>

-   然后在 DNS 设置中查找 DNS 缓存配置部分并将缓存大小设置为`0`（缓存已由 Unbound 处理）并单击应用。

<p align="center">
 <img src="https://i.imgur.com/8Q5Zb0M.jpg" width=650px height=370px>
 
<b>Click apply and test upstreams</b>(might get a error in the first testing only).

#### `IMPORTANT:`Windows 系统和 Android 浏览器需要一些调整`stabilize`DNS 解析器..Linux 工作正常<i>（在薄荷上测试）</i>

### 视窗

-   安装 Acrylic DNS 代理：[HTTPS://蚂蚁Akron.alter vista.org/support/acrylic/home.htm](https://mayakron.altervista.org/support/acrylic/Home.htm)

-   去`C:\Program Files (x86)\Acrylic DNS Proxy`并打开`AcrylicConfiguration.ini`文件。删除所有内容并复制这些设置[<a href="https://raw.githubusercontent.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/main/AcrylicConfiguration.ini"><b>点击这里</b></a>], 只改变_**主服务器地址**_到你的 Pi 的地址。

-   在同一个文件夹中运行`RestartAcrylicService.bat`&`PurgeAcrylicCacheData.bat`

    `TIP:`IP/DNS 命令故障排除

        ipconfig /release
        ipconfig /renew
        ipconfig /flushdns

### 安卓

-   在您使用的任何浏览器中，打开**离开**`Use Secure DNS`选项。
-   请注意，使用 build.prop DNS 调整或应用程序/Magisk 模块的自定义根 roms 和内核可能会发生冲突。

#### _就是这样_.现在去[HTTPS://1.1.1.1/help](https://1.1.1.1/help)在浏览器中，您应该会看到这些选项输出“是”。

-   [x] 连接到 1.1.1.1
-   [x] HTTPS 上的 DNS（DoH）
-   [x] 基于 TLS 的 DNS（DoT）
-   [ ] 基于 WARP 的 DNS
    <p align="center">
     <img src="https://i.imgur.com/2S3IH5H.jpg" width=650px height=370px>

#### 其他检查安全的网站

[HTTPS://browser leaks.com/DNS](https://browserleaks.com/dns)- 应该显示所有连接到“Cloudflare”

[HTTPS://呜呜呜.cloud flare.com/收视率/encrypted-是你/](https://www.cloudflare.com/ssl/encrypted-sni/)- “安全 DNS / DNSSEC / TLS 1.3”应该都是绿色的勾

[HTTPS://DNS Sec.vs.u你-毒蛾.的/](https://dnssec.vs.uni-due.de/)- 应该说“是的，您的 DNS 解析器验证 DNSSEC 签名”

**[⬆ 返回内容⬆](#table-of-contents)**

# 

# <i>安装 WireGuard</b></i>

**安装 WireGuard 之前**, 如果你没有<a href="https://www.google.com/search?client=firefox-b-d&q=static+IP"><b>静态IP</b></a>你需要得到一个免费的`Dynamic DNS Subdomain`否则您的外部 IP 地址会从您的 ISP 动态更改，因此您需要设置动态 DNS 服务[**<a href="https://github.com/trinib/Adguard-Wireguard-Unbound-Cloudflare/blob/main/Dns-Service-Guide.md"><b>点击这里</b></a>**].否则跳过这一步。

您还需要设置<a href="https://www.google.com/search?q=What+is+port+forwarding+used+for%3F&client=firefox-b-d&sxsrf=APq-WBuwPqGlPJ6N9_l6qpQ3e5sYoUxZAQ%3A1650219365125&ei=ZVlcYo6sB6SGwbkP8tGOwA8&ved=0ahUKEwjO8ryY2pv3AhUkQzABHfKoA_gQ4dUDCA0&uact=5&oq=What+is+port+forwarding+used+for%3F&gs_lcp=Cgdnd3Mtd2l6EAMyBggAEBYQHjoHCAAQRxCwAzoHCAAQsAMQQ0oECEEYAEoECEYYAFDMAVjMAWCBBWgBcAF4AIABbIgBbJIBAzAuMZgBAKABAqABAcgBCsABAQ&sclient=gws-wiz"><b>转发端口</b></a>在您的路由器上，这样您就可以在我们的网络之外访问 WireGuard，例如在咖啡店热点或您的移动数据中。
类型 |价值  
------------ \| -------------
设备 | Raspberry Pi 的主机名或 IP
协议 | UDP
端口范围 | 51820-51820
出港 | 51820
允许互联网访问（如果有）|是的

我的👇路由器👇端口设置。你的可能不同，但你会明白的。记住谷歌🔍搜索引擎🔎是你的朋友。如果您无法从外部网络进行连接，这意味着 ISP 已阻止传出连接，您可以打电话给他们并很好地询问以使其正常工作。

<p align="center">
 <img src="https://i.imgur.com/9LBEk1i.jpg">

* * *

👊非常感谢👊这个安装脚本来自<a href="https://github.com/Nyr/wireguard-install"><b>尼尔</b></a>.关注以保持更新。

在终端运行

    wget https://git.io/wireguard -O wireguard-install.sh && sudo bash wireguard-install.sh

-   该脚本将要求您提供 VPN 的公共 IPv4/主机名。_如果_您有静态 IP 然后继续，否则键入您从<a href="https://github.com/trinib/Adguard-Wireguard-Unbound-Cloudflare/blob/main/Dns-Service-Guide.md"><b>指示</b></a>.例如：trinibvpn.freeddns.org

-   对于端口选项`press enter`默认为 51820。对于客户端名称，只需输入您想要的任何名称，对于 DNS 使用选项 3 (`1.1.1.1`） 目前。您将配置`AdGuard/Unbound/Cloudflare`安装完成后使用VPN。

<p align="center">
 <img src="https://i.imgur.com/WUNZIK4.jpg">

-   等待安装完成并显示二维码，不要关闭。但如果你这样做，`regenerate qrcode`, 输入终端但只替换名称`yourclientname.conf`文件给你：


    sudo cp /root/yourclientname.conf /home/pi && sudo qrencode -t ansiutf8 < yourclientname.conf

`IMPORTANT:`您需要为与 VPN 一起使用的每台设备添加一个新用户/客户端。要添加新用户，只需重新运行脚本并创建具有不同客户端名称的用户。

<b>采用_开放式VPN_</b>[<a href="https://github.com/trinib/Adguard-Wireguard-Unbound-Cloudflare/blob/main/OpenVPN-Setup.md"><b>点击这里</b></a>]

# 

### 将 VPN 连接到 Android/IOS 手机

从 Google Play 或 App Store 安装 WireGuard 应用程序：

WireGuard（谷歌播放）：[HTTPS://play.Google.com/store/apps/details?ID=com.wire guard.Android](https://play.google.com/store/apps/details?id=com.wireguard.android)

WireGuard（应用商店）：[HTTPS://apps.apple.com/US/app/wire guard/ID1441195209](https://apps.apple.com/us/app/wireguard/id1441195209)

您需要使用 WireGuard 应用程序扫描终端中显示的二维码，选择`+ button`并使用该选项`Scan from QR code`安装配置。

`IMPORTANT`： 使能够**内核模块后端**在设置中

<p align="left">
 <img src="https://i.imgur.com/R4qbiOQ.jpg" width=250px height=350px>

### 将 VPN 连接到 Windows

用于窗户的 WireGuard：[HTTPS://download.wire guard.com/Windows-client/wire guard-installer.exe](https://download.wireguard.com/windows-client/wireguard-installer.exe)

-   创建一个`new text document`使用 PV 上的任何名称复制粘贴 WireGuard 客户端配置文件中的文本。

-   要查看客户端配置文件中的文本，请输入终端：


    sudo cat /root/yourclientname.conf

-   突出显示所有文本，将其复制并粘贴到 PC 上的 txt 文件中并保存。然后重命名扩展名`txt`到`conf`.现在您有了该 WireGuard 客户端的配置文件。

-   您现在可以将配置文件导入 WireGuard（从文件导入选项）。

## 配置 WireGuard`Adguard/Unbound/Cloudflare`

_请记住，这适用于当您在外部网络上或在家中 24/7 连接到 WireGuard VPN 时，因为您已经在您的设备上手动设置和运行 AdGuard/Unbound/Cloudflare。_（根据我的经验设置两者都没有问题）

-   在 WireGuard 应用程序中，选择您的隧道并选择编辑（右上角的铅笔）

-   在 DNS 服务器下输入`Pi's IP`并保存（IPv4 和 IPv6）

<p align="center">
 <img src="https://i.imgur.com/UC0vWfE.jpg" width=450px height=500px>  

### 限制流量

使用 WireGuard，您将失去大约 50% 的互联网速度，导致通过 Pi 隧道到路由器到设备的过程\*\*

删除允许的 IPs "0.0.0.0/0, ::/0" 选项，因为它将所有流量路由到您的家庭网络，这会很慢。您只需要通过您的地址发送流量。

-   首先，您需要将其替换为您的网络网关，但将最后一个数字设置为零并且<a href="https://www.google.com/search?q=prefix+length+explained&client=firefox-b-d&sxsrf=ALeKk036Jc9vJl73zVXf0yyZs5UlKRlNRQ%3A1621083125589&ei=9cOfYI66I5-qwbkPkdWxkAk&oq=prefix+length+explained&gs_lcp=Cgdnd3Mtd2l6EAMyBggAEAcQHjoHCCMQsAMQJzoHCAAQRxCwA1CUJ1iUJ2CiKmgBcAJ4AIABsAGIAdQCkgEDMC4ymAEAoAEBqgEHZ3dzLXdpesgBCcABAQ&sclient=gws-wiz&ved=0ahUKEwjOiOie3cvwAhUfVTABHZFqDJIQ4dUDCA0&uact=5"><b>前缀长度</b></a>至 24. 例如：`192.168.1.1/24`到`192.168.1.0/24`或者像我的 ISP 路由器`192.168.100.1/24`到`192.168.100.0/24`.~~**现在我只损失 25% 的速度**😁（PS.使用5g网络）~~

`UPDATE:`在 WireGuard 更新后，我没有得到更快的速度😞 .. 但它仍然有意义_不是_使用`"0.0.0.0/0, ::/0`带无线网络。如果有人知道任何调整以获得提升，请告诉我。

<p align="center">
 <img src="https://i.imgur.com/x4m6Pbl.jpg" width=450px height=500px>

### 请阅读 ！！ ， 意识到 ！！

`IMPORTANT`:_如果您的网络具有以 3 位数字（超过 24 个）结尾的设备的 IP 地址，例如：192.168.100。`254`，您将无法从外部网络正确路由，因为应用 24 仅允许数字 1 到 24。您需要改为`0`路由超出 24 范围，例如：`192.168.100.0/0`_.

或者您可以更改路由器上的 IP 范围（根据我的经验，您可能会获得更好的速度，因为它不会在 24 范围内路由不必要的允许 IP 地址）。

<p align="center">
 <img src="https://i.imgur.com/ZZ4aMUI.jpg" width=750px height=550px>

## Ипвш

如果您使用的是 IPv6，则在连接到 WiFi 时，您需要输入 WireGuard 允许的 IP`fe80::1/0`也是。例如`192.168.100.0/0, fe80::1/0`

在 windows PC 上连接以太网电缆时，您需要输入`::1`在“Internet 协议版本 6(TCP/IPv6)”首选 DNS 服务器中的 IPv6 地址中。

然后去[HTTPS://IP V6leak.com/](https://ipv6leak.com/)你应该看到“_您的 IPv6 没有泄漏_".

# 

## 禁用所有 IPv6

#### 如果您没有或不想要它，请禁用 IPv6[<a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/blob/main/Disable-All-IPv6.md"><b>点击这里</b></a>].结果，如果您的互联网较弱，禁用 IPv6 可以加快 dns 请求，但安全性较低。

# 

## 测试 VPN

你怎么知道 WireGuard VPN 是否真的有效？

为了**视窗**下载 Wireshark：[HTTPS://呜呜呜.Wireshark.org/#download](https://www.wireshark.org/#download)

下载后，您可以使用该应用程序检查协议设置为 WireGuard VPN 使用的协议的数据包。当数据包流量`encrypted`，例如可以这样读：

<p align="center">
 <img src="https://i.imgur.com/Tn4M47R.jpg">

为了**安卓**你可以使用 PCAPdroid：[HTTPS://play.Google.com/store/apps/details?ID=com.Emanuele发.remote_capture&后来=恩&公里=US](https://play.google.com/store/apps/details?id=com.emanuelef.remote_capture&hl=en&gl=US)

您应该看到所有连接`closed`和状态显示所有应用程序中的所有 DNS 而不是任何 TLS 连接。 （打开并使用 PCAPdroid 的应用程序进行扫描）

**[⬆ 返回内容⬆](#table-of-contents)**

* * *

# 

# <i>自动更新 Pi</b></i>

打开名为更新和复制粘贴脚本的新 sh 文件[<a href="https://raw.githubusercontent.com/trinib/Adguard-Wireguard-Unbound-Cloudflare/main/update.sh"><b>点击这里</b></a>]

    sudo nano update.sh

设置权限

    sudo chmod 700 update.sh

通过在命令行中输入打开 cron 文件`crontab -e`，在cron文件底部复制粘贴作业命令行并保存。

    0 3 * * WED sudo ./update.sh 2>&1 >/home/pi/updatelog

Pi 现在将在每周三凌晨 3 点更新。或者你可以去[HTTPS://crontab.guru/](https://crontab.guru/)并设置自己的时间表。

调整 Pi 的日期/时区在终端中输入：

    sudo dpkg-reconfigure tzdata

或手动设置

    sudo date -s "25 DEC 2012 11:14:00"

# 

# <i>安装 Log2Ram</b></i>

卸载 RAM 的最显着优势之一是它可以改善您的**SD 卡的潜在使用寿命**.
日志文件是您安装的各种软件写入最多的内容之一。
通过将文件推送到 RAM，您可以控制将它们写入 SD 卡的频率。您仍然可以访问 RAM 上的这些文件，就像它们位于您的 SD 卡上一样。

将此行复制并粘贴到终端中：

手动

    wget https://git.io/log2ram -O Log2Ram-Script.sh && sudo chmod +x Log2Ram-Script.sh && sudo ./Log2Ram-Script.sh

或者

添加 repo 源（自动更新）

    echo "deb [signed-by=/usr/share/keyrings/azlux-archive-keyring.gpg] http://packages.azlux.fr/debian/ bullseye main" | sudo tee /etc/apt/sources.list.d/azlux.list
    sudo wget -O /usr/share/keyrings/azlux-archive-keyring.gpg  https://azlux.fr/repo.gpg
    sudo apt update
    sudo apt install log2ram

# 

# <i>关闭 Pi LED 灯</b></i>

我猜 LED 的电源会影响不必要的电力和热量🤷😅。如果只是将其用作网络服务器，则无论如何都不需要它。通过在命令行中输入打开 cron 文件`crontab -e`，在cron文件底部复制粘贴作业命令行并保存。

绿

    @reboot echo none | sudo tee /sys/class/leds/led0/trigger

红色的

    @reboot echo none | sudo tee /sys/class/leds/led1/trigger

重启 Pi。

# 

# <i>保护您的树莓派</b></i>

<p align="center">
<a href="https://gist.github.com/boseji/c9e91ff3bd0b3cfb62a5e260fe505374"><img src="https://i.imgur.com/a9JQVls.png" width=80px height=90px></a>

[<a href="https://gist.github.com/boseji/c9e91ff3bd0b3cfb62a5e260fe505374"><b>点击这里</b></a>]

<i>（我只是使用 Fail2Ban 并更改 SSH 端口）</i>

**[⬆ 返回内容⬆](#table-of-contents)**

* * *

<b>任何使这些项目更好的问题、修复或提示请贡献🤖</b>

* * *

<p align="center">
<img src="https://user-images.githubusercontent.com/73097560/115834477-dbab4500-a447-11eb-908a-139a6edaec5c.gif"
<br> 
<br> 
<br> 

<p align="center">
 <img src="https://i.imgur.com/Q07E7SW.gif" width=500px height=30px>

<p align="center">
<a href="https://github.com/trinib/AdGuard-WireGuard-Unbound-Cloudflare/stargazers"><img src="https://reporoster.com/stars/dark/trinib/AdGuard-WireGuard-Unbound-Cloudflare"></a>

<p align="center">
<img src="https://user-images.githubusercontent.com/73097560/115834477-dbab4500-a447-11eb-908a-139a6edaec5c.gif"</p>

# 

## _存储库资源_

<h5 https://www.raspberrypi.com/documentation/

[HTTPS://GitHub.com/AD guard team/AD guard home/wiki/getting-started](https://github.com/AdguardTeam/AdGuardHome/wiki/Getting-Started)

[HTTPS://developers.cloud flare.com/](https://developers.cloudflare.com/)

[HTTPS://docs.皮-hole.net/guides/DNS/cloud flare的/](https://docs.pi-hole.net/guides/dns/cloudflared/)

[HTTPS://docs.皮-hole.net/guides/DNS/unbound/](https://docs.pi-hole.net/guides/dns/unbound/)

[HTTPS://NL net labs.哪里/documentation/unbound/unbound.conf/](https://nlnetlabs.nl/documentation/unbound/unbound.conf/)

[HTTPS://DNS privacy.org/DNS_privacy_clients/](https://dnsprivacy.org/dns_privacy_clients/)

[HTTPS://GitHub.com/按U的EP ND/pi hole-unbound](https://github.com/anudeepND/pihole-unbound)

[HTTPS://GitHub.com/申通/unbound.conf.的](https://github.com/stong/unbound.conf.d)

[HTTPS://GitHub.com/NYR/wire guard-install](https://github.com/Nyr/wireguard-install)

[HTTPS://GitHub.com/阿正陆续/log2RAM](https://github.com/azlux/log2ram)

[HTTPS://GitHub.com/T145/black-mirror](https://github.com/T145/black-mirror)

* * *
